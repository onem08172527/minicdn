worker_processes auto;

events { worker_connections 4096; }

http {
    lua_package_path "/etc/openresty/lua/?.lua;/etc/openresty/lua/?/init.lua;;";

    # Avoid buffering huge blobs in memory where possible
    client_body_buffer_size 128k;

    # Optional shared dict for lightweight locks / single-flight
    lua_shared_dict img_locks 10m;

    resolver 1.1.1.1 8.8.8.8 ipv6=off;

    server {
        listen 80;
        server_name 1img.tr;

        # Health
        location = /healthz {
            return 200 "ok\n";
        }

        # Resize: /resize/200x200?i=https://...
        location ~ ^/resize/(\d+)x(\d+)$ {
            content_by_lua_file /etc/openresty/lua/handlers/resize.lua;
        }

        # Crop: /crop/200x200?i=https://...
        location ~ ^/crop/(\d+)x(\d+)$ {
            content_by_lua_file /etc/openresty/lua/handlers/crop.lua;
        }

        # Rotate: /rotate/90?i=https://...
        location ~ ^/rotate/(-?\d+)$ {
            content_by_lua_file /etc/openresty/lua/handlers/rotate.lua;
        }

        # Purge a specific variant by calling the same URL but under /purge
        # Examples:
        #   /purge/resize/200x200?i=https://...   (deletes that cached key)
        #   /purge/crop/200x200?i=https://...
        #   /purge/rotate/90?i=https://...
        location ~ ^/purge/(resize|crop|rotate)/(.+)$ {
            content_by_lua_file /etc/openresty/lua/handlers/purge.lua;
        }
    }
}
